# 进程切换

## 进程切换流程

  如果想要从A进程切换到 B 进程，必定要**先从用户态切换到内核态**，因为这个切换的工作你不能让用户进程去实现，不然当 CPU 在用户进程手上的时候，
  他可以选择一直执行，不让出 CPU，这肯定是不允许的。所以操作系统需要先挂起正在占用 CPU 的 A 进程，才能切换到 B 进程。

  由于从用户态切换到内核态的时候，CPU 是在用户进程手中，所以这个是通过硬中断来实现的。在从用户态切换到内核态之前需要保存用户进程的上下文，
  以便下一次执行时可以继续之前的工作。

  这个上下文就是进程执行的环境，包括所有的寄存器变量，进程打开的文件、内存信息等。一个进程的上下文可以分为用户级上下文，寄存器上下文，系统级上下
  文。用户级上下文存储的是用户进程的内存数据以及堆栈数据等；寄存器上下文是一些通用寄存器；系统级上下文是内核栈、PCB (进程控制块)等

## 操作系统为什么分内核态和用户态，这两者之间如何切换

  因为在CPU的指令中，有一些操作是非常危险的，比如清理内存、设置时钟等。如果所有的程序都能使用，就可能造成系统的崩溃。所以，CPU 将指令分为特权指令和非特权指令，对于那些危险的指令，只允许操作系统使用。CPU 的特权级别有四级，从 Ring0 到 Ring3，正常使用时一般只有两级，**即用户态的 Ring3 和内核态的 Ring0**。Ring3 状态不能访问 Ring0 的地址空间，包括代码和数据。

## 用户态切换到内核态的三种方式

  系统调用（系统调用是通过软中断实现的）

  中断（硬）

  异常


https://i1.hoopchina.com.cn/hupuapp/bbs/111111/thread_111111_20220221173910_s_4335698_w_405_h_223_76555.gif?x-oss-process=image/resize,w_800/format,webp